{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<section class="soft-container mt-2 stats-enhanced">
  <!-- Header stats -->
  <div class="soft-grid cols-3">
    <div class="soft-card">
      <div style="font-size:.85rem;opacity:.7;">Completed Attempts</div>
      <div style="font-size:1.8rem;font-weight:700;color:var(--primary);">{{ stats.total_attempts }}</div>
    </div>
    <div class="soft-card">
      <div style="font-size:.85rem;opacity:.7;">Average Score</div>
      <div style="font-size:1.8rem;font-weight:700;color:var(--primary);">{{ stats.avg_score }}%</div>
    </div>
    <div class="soft-card">
      <div style="font-size:.85rem;opacity:.7;">Time Spent</div>
      <div style="font-size:1.8rem;font-weight:700;color:var(--primary);">{{ stats.time_spent }}</div>
    </div>
  </div>

  <!-- Achievements + Recent Activity -->
  <div class="soft-grid no-stretch" style="grid-template-columns:1fr 1fr; margin-top:1rem;">
    <div class="soft-card">
      <h3 style="margin:0 0 .75rem;">Your Achievements</h3>
      <div class="soft-grid cols-4" style="grid-template-columns:repeat(2,1fr);">
        <div class="badge-achievement">
          <div class="badge-icon gold">üèÖ</div>
          <div class="badge-title">First Quiz</div>
          <div class="badge-desc">Complete one quiz</div>
        </div>
        <div class="badge-achievement">
          <div class="badge-icon blue">üìò</div>
          <div class="badge-title">10 Quizzes</div>
          <div class="badge-desc">Reach ten attempts</div>
        </div>
        <div class="badge-achievement">
          <div class="badge-icon green">‚≠ê</div>
          <div class="badge-title">Perfect Score</div>
          <div class="badge-desc">Get 100% once</div>
        </div>
        <div class="badge-achievement locked">
          <div class="badge-icon blue">üéØ</div>
          <div class="badge-title">Category Master</div>
          <div class="badge-desc">80% in 3 categories</div>
        </div>
      </div>
    </div>
    <div class="soft-card">
      <h3 style="margin:0 0 .75rem;">Recent Activity</h3>
      {% if recent %}
        {% for a in recent %}
          <div class="activity-soft">
            <div class="top-row" style="font-weight: bold;font-size: .90rem;">{{ a.quiz.title }}</div>
            <div class="meta" style="font-weight: bold;font-size: .90rem;"><span>{{ a.started_at|date:"M d, Y H:i" }}</span>{% if a.is_completed %}<span>Score {{ a.score }}%</span>{% else %}<span>Ongoing</span>{% endif %}</div>
            {% if a.is_completed %}
              <div class="score-chip {% if a.score >= 80 %}good{% elif a.score >= 50 %}medium{% else %}low{% endif %}">{{ a.score }}%</div>
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <div style="color:var(--text-light);">No recent attempts</div>
      {% endif %}
    </div>
  </div>

  <!-- Charts and lists -->
  <div class="soft-grid no-stretch" style="grid-template-columns:1.2fr 1fr; margin-top:1rem;">
    <div class="soft-card tight">
      <h3 style="margin:0 0 .5rem;">Progress Over Time</h3>
      <canvas id="lineChart" height="140"></canvas>
    </div>
    <div class="soft-card tight">
      <h3 style="margin:0 0 .5rem;">Category Breakdown</h3>
      <canvas id="pieChart" height="140"></canvas>
    </div>
  </div>

  <div class="soft-grid" style="grid-template-columns:1fr 1fr; margin-top:1rem;">
    <div class="soft-card">
      <h3 style="margin:0 0 .5rem;">Best Performance</h3>
      {% if best %}
        <ol style="margin:0;padding-left:1.2rem;">
          {% for a in best %}
            <li style="margin:.35rem 0;">{{ a.quiz.title }} ‚Äî <strong>{{ a.score }}%</strong> ({{ a.started_at|date:"M d" }})</li>
          {% endfor %}
        </ol>
      {% else %}
        <div style="color:var(--text-light);">Complete some quizzes to see your top scores.</div>
      {% endif %}
    </div>
    <div class="soft-card">
      <h3 style="margin:0 0 .5rem;">Needs Improvement</h3>
      {% if needs %}
        <ol style="margin:0;padding-left:1.2rem;">
          {% for a in needs %}
            <li style="margin:.35rem 0;">{{ a.quiz.title }} ‚Äî <strong>{{ a.score }}%</strong> ({{ a.started_at|date:"M d" }})</li>
          {% endfor %}
        </ol>
      {% else %}
        <div style="color:var(--text-light);">No low scores yet ‚Äî great job!</div>
      {% endif %}
    </div>
  </div>
</section>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(function(){
  const root = document.documentElement;
  const primary = getComputedStyle(root).getPropertyValue('--primary') || '#6366f1';
  const grid = root.getAttribute('data-theme') === 'dark' ? 'rgba(255,255,255,.12)' : 'rgba(0,0,0,.07)';
  const lineLabels = {{ line_labels|safe }};
  const lineScores = {{ line_scores|safe }};
  const cats = {{ categories_data|safe }};
  const pieLabels = cats.map(c=>c.label);
  const pieData = cats.map(c=>c.count);

  const lc = document.getElementById('lineChart');
  if (lc && lineLabels.length) {
    new Chart(lc, {
      type: 'line',
      data: { labels: lineLabels, datasets: [{ label:'Score %', data: lineScores, tension:.25, borderColor: primary, backgroundColor: 'rgba(99,102,241,.25)', pointRadius:3 }] },
      options: { plugins:{ legend:{ display:false }, tooltip:{ titleFont:{ size:13 }, bodyFont:{ size:12 } } }, scales:{ x:{ grid:{ color:grid }, ticks:{ font:{ size:12 } } }, y:{ grid:{ color:grid }, suggestedMin:0, suggestedMax:100, ticks:{ font:{ size:12 } } } } }
    });
  }
  const pc = document.getElementById('pieChart');
  if (pc && pieLabels.length) {
    const colors = ['#6366f1','#22c55e','#eab308','#06b6d4','#f97316','#84cc16','#8b5cf6'];
    new Chart(pc, { type:'pie', data:{ labels: pieLabels, datasets:[{ data: pieData, backgroundColor: pieLabels.map((_,i)=>colors[i%colors.length]) }] }, options:{ plugins:{ legend:{ position:'bottom', labels:{ font:{ size:12 } } } } } });
  }
})();
</script>
{% endblock %}
