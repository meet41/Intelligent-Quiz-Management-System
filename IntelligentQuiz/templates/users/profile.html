{% extends 'base.html' %}

{% block content %}
<div class="profile-container">
    <!-- Profile Header -->
    <div class="profile-header">
        <h1>Profile</h1>
        <p>Manage your account settings and quiz preferences</p>
    </div>

    <div class="profile-grid">
        <!-- Left Column - Profile Info -->
        <div class="profile-info">
            <form method="post" enctype="multipart/form-data" class="profile-form">
                {% csrf_token %}
                <div class="profile-card">
                    <div class="profile-image-container" style="position: relative; width: 150px; height: 150px; margin: 0 auto;">
                        {% if user.profile.image %}
                            <img src="{{ user.profile.image.url }}" alt="Profile picture" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid var(--primary);">
                        {% else %}
                            <div style="width: 150px; height: 150px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                    <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                                    <circle cx="12" cy="7" r="4"/>
                                </svg>
                            </div>
                        {% endif %}
                        <label for="{{ p_form.image.id_for_label }}" style="position: absolute; bottom: 0; right: 0; background: var(--primary); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                                <circle cx="12" cy="13" r="4"/>
                            </svg>
                        </label>
                        {{ p_form.image }}
                    </div>

                    <div style="margin: 2rem 0;">
                        <div class="form-group">
                            <label for="{{ u_form.username.id_for_label }}">Username</label>
                            {{ u_form.username }}
                        </div>
                        <div class="form-group">
                            <label for="{{ u_form.email.id_for_label }}">Email</label>
                            {{ u_form.email }}
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="{{ u_form.first_name.id_for_label }}">First Name</label>
                                {{ u_form.first_name }}
                            </div>
                            <div class="form-group">
                                <label for="{{ u_form.last_name.id_for_label }}">Last Name</label>
                                {{ u_form.last_name }}
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="{{ p_form.bio.id_for_label }}">Bio</label>
                            {{ p_form.bio }}
                        </div>
                    </div>
                    <button type="submit" class="btn">Save Changes</button>
                </div>
            </form>
        </div>

        <!-- Right Column - Stats & Activity -->
        <aside class="profile-sidebar">
            <div class="stats-grid">
                <div class="stat-card">
                    <h4>Total Quizzes</h4>
                    <div class="stat-number">{{ quiz_count }}</div>
                </div>
                <div class="stat-card">
                    <h4>Average Score</h4>
                    <div class="stat-number">{{ avg_score }}%</div>
                </div>
                <div class="stat-card">
                    <h4>Best Score</h4>
                    <div class="stat-number">{{ best_score }}%</div>
                </div>
            </div>

            <div class="profile-card">
                <h3 style="margin-top:0; display:flex; align-items:center; gap:.5rem;">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    Recent Activity
                </h3>
                {% if recent_attempts %}
                    <div style="display:flex; flex-direction:column; gap: .75rem;">
                        {% for attempt in recent_attempts %}
                            <div class="activity-item">
                                <div>
                                    <div style="font-weight: 500;">{{ attempt.quiz.title }}</div>
                                    <div style="color: var(--text); opacity: 0.7; font-size: 0.875rem;">
                                        {{ attempt.created_at|date:"F j, Y" }}
                                    </div>
                                </div>
                                <div style="display:flex; align-items:center; gap: .75rem;">
                                    {% if attempt.score >= 80 %}
                                        <div class="quiz-score score-high">{{ attempt.score }}%</div>
                                    {% elif attempt.score >= 60 %}
                                        <div class="quiz-score score-medium">{{ attempt.score }}%</div>
                                    {% else %}
                                        <div class="quiz-score score-low">{{ attempt.score }}%</div>
                                    {% endif %}
                                    <a href="{% url 'quiz_result' attempt.id %}" class="btn btn-outline">View</a>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div style="text-align:center; padding: 1rem 0; color: var(--text-light);">No recent attempts</div>
                {% endif %}
            </div>
        </aside>
    </div>

<style>
    :root {
        --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --success-color: #10B981;
        --warning-color: #F59E0B;
        --danger-color: #EF4444;
    }

    .profile-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }

    .profile-header {
        text-align: center;
        margin-bottom: 3rem;
        animation: fadeIn 0.5s ease-out;
    }

    .profile-header h1 {
        font-size: 2.5rem;
        color: var(--primary);
        margin-bottom: 0.5rem;
    }

    .profile-header p {
        color: var(--text);
        opacity: 0.8;
    }

    .profile-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
        margin-top: 2rem;
    }

    .profile-card {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: var(--card-shadow);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .profile-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .profile-image-container {
        position: relative;
        width: 180px;
        height: 180px;
        margin: 0 auto 2rem;
    }

    .profile-image-container img {
        width: 180px;
        height: 180px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid var(--primary);
        transition: transform 0.3s ease;
    }

    .profile-image-container img:hover {
        transform: scale(1.05);
    }

    .camera-button {
        position: absolute;
        bottom: 0;
        right: 0;
        background: var(--primary);
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: var(--card-shadow);
        transition: transform 0.2s ease;
    }

    .camera-button:hover {
        transform: scale(1.1);
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text);
        font-weight: 500;
        transition: color 0.2s ease;
    }

    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 1rem;
        border: 2px solid var(--border);
        border-radius: 0.75rem;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: var(--bg);
    }

    .form-group input:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
        transform: translateY(-2px);
    }

    .form-group:hover label {
        color: var(--primary);
    }

    .profile-image-container input[type="file"] {
        display: none;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1.5rem;
        border-radius: 0.75rem;
        font-weight: 600;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        min-width: 200px;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--card-shadow);
    }

    .btn-primary {
        background: var(--primary);
        color: white;
    }

    .btn-secondary {
        background: var(--text);
        color: white;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin: 2rem 0;
    }

    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 1rem;
        text-align: center;
        box-shadow: var(--card-shadow);
        transition: transform 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: var(--primary);
        margin: 0.5rem 0;
    }

    .recent-activity {
        margin-top: 2rem;
    }

    .activity-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: var(--bg);
        border-radius: 0.75rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .activity-item:hover {
        transform: translateX(5px);
        box-shadow: var(--card-shadow);
    }

    .quiz-score {
        font-weight: 600;
        padding: 0.5rem 1rem;
        border-radius: 2rem;
    }

    .score-high {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success-color);
    }

    .score-medium {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning-color);
    }

    .score-low {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger-color);
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @media (max-width: 768px) {
        .profile-grid {
            grid-template-columns: 1fr;
        }

        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Image preview
        const imageInput = document.querySelector('input[type="file"]');
        const profileImage = document.querySelector('.profile-image-container img');
        
        imageInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    if (profileImage) {
                        profileImage.style.transform = 'scale(0.8)';
                        setTimeout(() => {
                            profileImage.src = e.target.result;
                            profileImage.style.transform = 'scale(1)';
                        }, 200);
                    } else {
                        const newImage = document.createElement('img');
                        newImage.src = e.target.result;
                        newImage.alt = 'Profile picture';
                        newImage.style = 'width: 180px; height: 180px; border-radius: 50%; object-fit: cover; border: 4px solid var(--primary);';
                        document.querySelector('.profile-image-container div').replaceWith(newImage);
                    }
                }
                
                reader.readAsDataURL(this.files[0]);
            }
        });

        // Form animations
        const formGroups = document.querySelectorAll('.form-group');
        formGroups.forEach(group => {
            const input = group.querySelector('input, textarea');
            input.addEventListener('focus', () => group.classList.add('active'));
            input.addEventListener('blur', () => {
                if (!input.value) group.classList.remove('active');
            });
        });

        // Stat cards animation
        const statCards = document.querySelectorAll('.stat-card');
        const observer = new IntersectionObserver(entries => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.animation = 'fadeIn 0.5s ease-out forwards';
                    observer.unobserve(entry.target);
                }
            });
        });

        statCards.forEach(card => observer.observe(card));
    });
</script>
{% endblock %}
